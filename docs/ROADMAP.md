# План разработки

## Цель MVP

Запустить работающую систему за **4 недели** (февраль 2024), которая автоматизирует 80% рутинной работы с простыми заявками (1-3 позиции).

## Неделя 1: Фундамент (7-14 фев)

### Цели
✅ Развернуть инфраструктуру
✅ Создать структуру проекта
✅ Настроить базу данных

### Задачи

**День 1-2: Проект и инфраструктура**
- [ ] Создать структуру проекта (backend/, frontend/, docs/)
- [ ] Настроить виртуальное окружение
- [ ] requirements.txt с зависимостями
- [ ] .env.example с конфигурацией
- [ ] Docker-compose (PostgreSQL + Redis локально)

**День 3-4: База данных**
- [ ] SQLAlchemy модели (clients, orders, suppliers, etc.)
- [ ] Alembic - initial migration
- [ ] Seed скрипт (тестовые данные)
- [ ] Утилиты (numbering.py для ORD-2024-0001)

**День 5: FastAPI**
- [ ] Базовое FastAPI приложение
- [ ] Подключение к PostgreSQL
- [ ] Health check endpoint
- [ ] Базовая auth (JWT для веба)

**День 6-7: Telegram бот**
- [ ] aiogram инициализация
- [ ] Базовые команды (/start, /help)
- [ ] Whitelist пользователей (2 admin ID)
- [ ] Подключение к общей БД

### Критерии готовности
- ✅ FastAPI запускается, отвечает на /health
- ✅ PostgreSQL создается с таблицами
- ✅ Telegram бот отвечает на /start
- ✅ Можно добавить тестовую заявку через API

---

## Неделя 2: Email + AI (14-21 фев)

### Цели
✅ Настроить прием писем
✅ AI парсинг заявок
✅ Автоматическая регистрация заявок

### Задачи

**День 1-2: Email IMAP**
- [ ] Сервис email_service.py
- [ ] Подключение к mail.ru IMAP
- [ ] Polling фоновая задача (каждые 30 сек)
- [ ] Парсинг email (from, subject, body, message-id)
- [ ] Сохранение исходного письма в БД

**День 3-4: AI парсинг**
- [ ] OpenAI API интеграция
- [ ] Промпт для парсинга заявок
  ```
  Извлеки из email:
  - Название компании клиента
  - ИНН
  - Контакты
  - Список товаров с количеством
  ```
- [ ] ai_parser.py с retry логикой
- [ ] Fallback при ошибке → уведомление в Telegram

**День 5: Регистрация заявок**
- [ ] Создание заявки из parsed данных
- [ ] Генерация номера (ORD-2024-XXXX)
- [ ] Создание клиента если нет в БД (по ИНН)
- [ ] Создание order_items

**День 6-7: CRUD поставщиков через бот**
- [ ] /add_supplier - добавить поставщика
- [ ] /search_suppliers - поиск по категории
- [ ] /list_suppliers - список всех
- [ ] /edit_supplier - редактировать
- [ ] Проверка дубликатов по ИНН

### Критерии готовности
- ✅ Email приходит → автоматически создается заявка
- ✅ AI парсит 90% простых заявок корректно
- ✅ Уведомление в Telegram о новой заявке
- ✅ Можно добавить поставщика через бота

---

## Неделя 3: Автоматизация (21-28 фев)

### Цели
✅ Автоматическая рассылка запросов
✅ Парсинг ответов поставщиков
✅ Базовый веб-интерфейс

### Задачи

**День 1-2: Рассылка email**
- [ ] email_service.send_supplier_request()
- [ ] SMTP отправка через mail.ru
- [ ] Генерация уникального Message-ID
- [ ] Сохранение supplier_request в БД
- [ ] Шаблон письма запроса
- [ ] Throttling (не более 50 писем/час)

**День 3: Workflow рассылки**
- [ ] API endpoint: POST /api/orders/{id}/send_requests
- [ ] Выбор поставщиков через бот
- [ ] Массовая отправка всем выбранным
- [ ] Статусы запросов (pending → sent → replied)

**День 4-5: Парсинг ответов**
- [ ] IMAP определяет ответ поставщика (по In-Reply-To)
- [ ] Находим supplier_request по message_id
- [ ] AI парсит ответ (цена, срок, условия)
- [ ] Создаем supplier_quote
- [ ] Уведомление в Telegram

**День 6-7: Веб-интерфейс (базовый)**
- [ ] HTML страницы (Alpine.js + Tailwind)
- [ ] Список заявок (orders.html)
- [ ] Детали заявки (order_detail.html)
- [ ] Таблица поставщиков (suppliers.html)
- [ ] FastAPI serve статики

### Критерии готовности
- ✅ Менеджер выбирает поставщиков → автоматически рассылаются запросы
- ✅ Ответ поставщика → автоматически парсится → котировка в БД
- ✅ Веб-интерфейс показывает список заявок
- ✅ Можно открыть заявку и увидеть статус

---

## Неделя 4: КП и тестирование (28 фев - 6 мар)

### Цели
✅ Сравнение предложений
✅ Генерация КП
✅ Полное тестирование на реальных данных

### Задачи

**День 1-2: Сравнение предложений**
- [ ] API endpoint: GET /api/orders/{id}/quotes
- [ ] Веб-страница сравнения
- [ ] Таблица с сортировкой (цена, срок)
- [ ] Выбор лучшего предложения (checkbox)
- [ ] Расчет маржи (configurable %)

**День 3-4: Генерация КП**
- [ ] pdf_generator.py (ReportLab или WeasyPrint)
- [ ] Шаблон КП (header, таблица, footer)
- [ ] Генерация номера (OFF-2024-XXXX)
- [ ] Сохранение PDF в Cloudflare R2
- [ ] Email отправка КП клиенту

**День 5: Аудит и логирование**
- [ ] audit_log для всех операций
- [ ] Middleware для логирования API запросов
- [ ] Telegram уведомления об ошибках
- [ ] Health check для всех сервисов

**День 6-7: Тестирование**
- [ ] Тестовые заявки (10 шт)
- [ ] Проверка всего workflow end-to-end
- [ ] Нагрузочное тестирование (20 заявок одновременно)
- [ ] Исправление багов
- [ ] Деплой в production (Railway)

### Критерии готовности
- ✅ Полный цикл работает: email → заявка → рассылка → ответы → КП → отправка
- ✅ Можно обработать 10 заявок за день
- ✅ Система развернута в production
- ✅ Команда обучена работе

---

## После MVP (март-апрель 2024)

### v1.1 (1-2 недели)
- [ ] Избранные поставщики (favorites)
- [ ] Статистика (простая)
- [ ] Нечеткий поиск поставщиков
- [ ] Redis кеш для частых запросов
- [ ] Sentry для мониторинга ошибок
- [ ] Базовые pytest тесты

### v2.0 (1-1.5 месяца)
- [ ] **Интеграция с 1С** - выгрузка счетов
- [ ] **Интеграция с Bitrix24** - синхронизация сделок
- [ ] OCR для PDF/картинок (Tesseract/Google Vision)
- [ ] Celery для фоновых задач
- [ ] Дедупликация заявок
- [ ] Расширенная аналитика

### v3.0 (3-4 месяца)
- [ ] Предиктивная аналитика (ML модель для выбора поставщика)
- [ ] Автоматическое формирование КП (полностью через AI)
- [ ] Мобильное приложение (React Native)
- [ ] API для интеграций
- [ ] Голосовые заметки (speech-to-text)
- [ ] Чат-бот для клиентов

---

## Риски и митигация

| Риск | Вероятность | Влияние | Митигация |
|------|-------------|---------|-----------|
| AI парсинг работает плохо | Средняя | Высокое | Fallback на ручной ввод |
| Mail.ru блокирует за спам | Средняя | Высокое | Резерв SendGrid |
| Не успеваем за 4 недели | Высокая | Среднее | Урезаем скоуп (без веба) |
| OpenAI API дорогой | Низкая | Среднее | Переход на более дешевую модель |
| PostgreSQL переполнится | Низкая | Низкое | Monitoring + cleanup старых данных |

## Метрики отслеживания

### Еженедельный прогресс

**Неделя 1**:
- ✅ Инфраструктура работает
- ✅ БД создана с миграциями
- ✅ Fastapi + Telegram bot запущены

**Неделя 2**:
- ✅ Email интеграция работает
- ✅ AI парсит заявки
- ✅ CRUD поставщиков готов

**Неделя 3**:
- ✅ Автоматическая рассылка работает
- ✅ Парсинг ответов работает
- ✅ Веб показывает заявки

**Неделя 4**:
- ✅ КП генерируется
- ✅ Полный цикл работает
- ✅ Система в production

### Финальные KPI (конец недели 4)

- [ ] **Функциональность**: 10 заявок обработаны полностью
- [ ] **Скорость**: Среднее время обработки < 1 час
- [ ] **Надежность**: Uptime > 95% (первая неделя)
- [ ] **Точность**: AI парсинг > 85% корректно
- [ ] **Удобство**: Команда может работать без помощи

---

**Важно**: Это aggressive план. Если не успеваем - сокращаем скоуп:
1. Убираем веб-интерфейс (только Telegram)
2. Ручное сравнение предложений (без автопарсинга ответов)
3. Простой текстовый КП (без PDF)

**Цель** - работающая система, пусть с костылями, но автоматизирующая хотя бы 50% работы.
