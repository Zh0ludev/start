# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Обзор проекта

**Start** - CRM-система для автоматизации оптовой B2B торговли инженерным оборудованием по модели dropshipping.

**Основной workflow**: Email от клиента → AI парсинг → автоматическая рассылка поставщикам → сбор котировок → сравнение → генерация PDF КП → отправка клиенту.

**Пользователи**: Команда из 2 человек (снабженцы), обрабатывают 10-20 простых заявок в день (1-3 позиции).

**Сроки**: MVP за 4 недели, сейчас стадия документации (неделя 1).

## Архитектура системы

### Три интерфейса
1. **Telegram-бот** - уведомления, быстрый доступ, управление поставщиками (мобильный)
2. **Веб-интерфейс** - списки заявок, сравнительные таблицы, детальная работа (десктоп)
3. **Email-шлюз** - автоматический прием (IMAP) и рассылка запросов (SMTP)

### Ключевые архитектурные концепции

**1. Сквозная трассируемость**
Каждая заявка имеет полную историю от первого email до итогового КП в таблице `audit_log`. Это КРИТИЧНО - никогда не удалять записи аудита.

**2. Отслеживание email-цепочек**
- Исходящий запрос получает уникальный `Message-ID: <req-ORD-2024-0052-5@domain.ru>`
- Ответ поставщика содержит `In-Reply-To: <req-...>`
- Система связывает ответы с запросами через Message-ID
- ВАЖНО: Никогда не отправлять email без генерации правильного Message-ID

**3. Система нумерации**
Все сущности используют префиксные последовательные ID:
- `ORD-2024-XXXX` - заявки
- `REQ-2024-XXXX` - запросы поставщикам
- `QUO-2024-XXXX` - котировки
- `OFF-2024-XXXX` - коммерческие предложения

Реализация: `utils/numbering.py` с логикой сброса по годам.

**4. Двухэтапный AI парсинг**
- Этап 1: Парсинг входящего email от клиента → структурированные данные заявки
- Этап 2: Парсинг ответа поставщика → структурированные данные котировки
- Оптимизация стоимости: кеширование частых названий товаров для снижения API-вызовов
- КРИТИЧНО: При ошибке AI сохранять исходное письмо + уведомление в Telegram, никогда не терять данные

### Структура БД

**Основная связь**: `order` → `order_items` + `supplier_requests` → `supplier_quotes` → `client_offer`

Ключевые решения:
- PostgreSQL для транзакций, Redis для кеша (не в MVP)
- Таблица `audit_log` логирует ВСЕ изменения со старыми/новыми значениями в JSONB
- Поле `email_message_id` в `supplier_requests` обеспечивает трекинг цепочек
- ИНН - уникальный ключ для клиентов и поставщиков

## Обоснование технологий

**FastAPI вместо Django**: Лучшая поддержка async для IMAP polling, быстрая разработка.

**aiogram 3.x**: Современная async библиотека для Telegram с поддержкой клавиатур.

**Alpine.js вместо React**: Без сборки, идеально для команды из 2 человек, минимум JS.

**mail.ru вместо Gmail**: Клиент уже использует, но есть лимиты SMTP (~100 писем/день).

**GPT-4o-mini**: Экономично ($5-10/месяц на 600 парсингов), приемлемая точность (>85%).

**Railway/Render**: Автодеплой, managed PostgreSQL, просто для маленькой команды.

## Критические ограничения и риски

### Жесткие лимиты
- **Mail.ru SMTP**: Максимум 100 писем/день (20 заявок × 5 поставщиков = 100)
- **OpenAI Tier 1**: 60 запросов/мин (достаточно для текущего объема)
- **Целевой scope**: Только простые заявки (1-3 позиции), сложные обрабатываются вручную
- **Нет offline-режима**: Система требует подключения к интернету

### Известный технический долг
- Нет тестов в MVP (добавить pytest на неделе 4)
- Нет Docker до завершения MVP
- Нет CI/CD изначально (GitHub Actions после MVP)
- Синхронный email polling (миграция на Celery в v2.0)
- Монолитная архитектура (приемлемо для MVP, рефакторинг в v3.0)

### Стратегия обработки ошибок

**НЕ молчать при ошибках**. Каждая ошибка требует:
1. Уведомление в Telegram админам
2. Сохранение в audit_log со стектрейсом
3. Graceful degradation (например, AI не сработал → опция ручного ввода)

**Примеры**:
- Ошибка AI парсинга → уведомление + сохранение нераспарсенного письма
- Timeout поставщика (48ч) → уведомление + предложение альтернатив
- PostgreSQL недоступна → буферизация в Redis + retry
- Лимит SMTP исчерпан → очередь + алерт

Подробные сценарии ошибок см. в [docs/LIMITATIONS.md](docs/LIMITATIONS.md).

## Команды для разработки

### Настройка (когда появится код)
```bash
python -m venv venv
source venv/bin/activate  # Linux/Mac
pip install -r requirements.txt
cp .env.example .env       # Заполнить реальными credentials
alembic upgrade head       # Запустить миграции
```

### Запуск сервисов
```bash
# Разработка (отдельные терминалы)
python backend/main.py          # FastAPI на :8000
python backend/bot/main.py      # Telegram бот

# Production
# Деплой на Railway.app с автодеплоем из main ветки
```

### Миграции БД
```bash
alembic revision --autogenerate -m "Описание"
alembic upgrade head
alembic downgrade -1           # Откат последней
```

### Стратегия тестирования (после MVP)
```bash
pytest tests/                   # Все тесты
pytest tests/test_ai_parser.py -v  # Конкретный модуль
pytest -k "test_email"         # По ключевому слову
```

## Структура ключевых файлов

**После создания** проект будет иметь:

```
backend/
├── main.py              # Точка входа FastAPI
├── config.py            # Все env переменные, настройки
├── database/
│   ├── models.py        # SQLAlchemy модели (ОДИН ФАЙЛ изначально)
│   └── database.py      # Подключение к БД, управление сессиями
├── services/
│   ├── email_service.py    # IMAP polling + SMTP отправка
│   ├── ai_parser.py        # Интеграция с OpenAI + промпт-инжиниринг
│   └── pdf_generator.py    # Генерация КП
├── bot/
│   ├── main.py          # Точка входа Telegram бота
│   └── handlers/        # Обработчики команд (/start, /add_supplier и т.д.)
└── utils/
    └── numbering.py     # Генерация последовательных ID с префиксом года
```

## Важные рекомендации по разработке

### AI парсинг
- Использовать structured output (JSON mode) для надежности
- Включать примеры в промпты для лучшей точности
- Устанавливать temperature=0 для детерминированного парсинга
- Реализовать retry логику (макс 3 попытки с экспоненциальной задержкой)
- Отслеживать процент успешного парсинга в логах

### Работа с email
- ВСЕГДА устанавливать правильный Message-ID на исходящие письма
- Парсить заголовок In-Reply-To для связывания ответов
- Сохранять полное исходное письмо (заголовки + тело) для отладки
- Соблюдать лимиты mail.ru: макс 50 писем/час с throttling

### Безопасность
- Никогда не коммитить файл .env (использовать шаблон .env.example)
- JWT токены для веба (refresh tokens в v2.0)
- Telegram бот: whitelist user ID в конфиге
- Использовать исключительно SQLAlchemy ORM (никакого raw SQL для предотвращения injection)
- Требуется настройка CORS для веб API

### Производительность
- IMAP polling: интервал 30 сек (приемлемо для MVP)
- AI парсинг: ~5 сек на письмо (приемлемо для 20/день)
- Генерация PDF: ~3 сек на КП (использовать фоновую задачу в v2.0)
- Нет кеширования в MVP (добавить Redis в v1.1)

## Деплой

**Платформа**: Railway.app (основная) или Render.com (резервная)

**Переменные окружения** (см. .env.example после создания):
```env
DATABASE_URL=postgresql://...     # Managed PostgreSQL
TELEGRAM_BOT_TOKEN=...
TELEGRAM_ADMIN_IDS=123,456        # Whitelist
EMAIL_USERNAME=...@mail.ru
EMAIL_PASSWORD=...
OPENAI_API_KEY=sk-...
SECRET_KEY=...                    # Для JWT
```

**Мониторинг**:
- Railway dashboard для логов/метрик
- UptimeRobot пингует /health endpoint
- Telegram уведомления об ошибках

## Критерии успеха MVP

К концу недели 4:
- ✅ Обработка 10-20 заявок/день автоматически
- ✅ Экономия времени 80% (с 4 часов до 45 минут на заявку)
- ✅ Нет потерянных заявок (полный audit trail)
- ✅ От email до рассылки поставщикам < 5 минут
- ✅ Точность AI парсинга > 85%

## Текущий статус

**Неделя 1** - Документация завершена, начало создания структуры проекта.

Следующие шаги:
1. Создать структуру директорий backend/
2. Настроить SQLAlchemy модели на основе схемы из docs/DATABASE.md (когда будет создана)
3. Инициализировать скелеты FastAPI + Telegram бота
4. Настроить подключение к PostgreSQL

См. [docs/ROADMAP.md](docs/ROADMAP.md) для детального плана по неделям.

## Справочные материалы

- [README.md](README.md) - Краткий обзор
- [docs/LIMITATIONS.md](docs/LIMITATIONS.md) - Ограничения, риски, технический долг
- [docs/ROADMAP.md](docs/ROADMAP.md) - План разработки на 4 недели
- Детали архитектуры, схема БД, workflows - будут созданы в docs/

---

**Философия**: Выпускать быстро, итерировать. MVP должен автоматизировать 50-80% работы, а не быть идеальным. Приоритет - работающий end-to-end flow, а не отполированные фичи.
